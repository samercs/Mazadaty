@using System.Globalization
@using Kendo.Mvc.Infrastructure
@using Kendo.Mvc.UI
@using Mzayad.Web.Areas.admin.Models.Products
@using Mzayad.Web.Extensions
@model Mzayad.Web.Areas.admin.Models.Products.EditViewModel

@{
    ViewBag.Title = "Edit Product";
}

@section styles {
    @Styles.Render("~/css/image-uploader")
    <style>
        .disabledLabel {
            color: grey;
        }

        .disabledCheckbox {
            opacity: .5;
        }

        .categoriesList {
            list-style-type: none;
            padding: 0;
        }

        .childCategoriesList {
            list-style-type: none;
            padding-left: 20px;
        }
    </style>
}

@helper RenderSpecification(EditViewProductSpecification model)
{

    <div class="form-group">
        <div class="row">
            <div class="col-md-6">
                @Html.DropDownList("SelectedSpecification", model.SpecificationItems, new { @class = "form-control PSDropDown checkMultiPS" })

            </div>
            <div class="col-md-6">
                @Html.EditorFor(i => model.ProductSpecification.Value)
            </div>
        </div>
    </div>
}

<div class="row">

    <div class="@Html.Css().FormWide">

        @using (Html.BeginForm())
        {
            @Html.AntiForgeryToken()

            <section>
                <div class="form-group">
                    @Html.LabelFor(i => i.Product.Name, "Name")
                    @Html.EditorFor(i => i.Product.Name, Model)
                    @Html.ValidationMessageFor(i => i.Product.Name, "Please enter a product name.")
                </div>
                <div class="form-group">
                    @Html.LabelFor(i => i.Product.Description, "Description")
                    @Html.EditorFor(i => i.Product.Description, Model)
                    @Html.ValidationMessageFor(i => i.Product.Description, "Please enter a product description.")
                </div>


            </section>


            <section id="ProductSpecification">

                <div class="form-group">
                    @Html.Label("Specifications")
                </div>
                @foreach (var spcification in Model.EditViewProductSpecifications)
                {
                    @RenderSpecification(spcification)
                }
                <div class="form-group">
                    @Html.ValidationMessage("SelectedSpecification")
                </div>
            </section>

            <section>
                <div class="form-group">
                    @Html.LabelFor(i => i.Product.RetailPrice, "Retail Price")
                    <div class="input-group">
                        <span class="input-group-addon">KWD</span>
                        @Html.TextBoxFor(i => i.Product.RetailPrice, new { @class = "form-control form-control-md", @type = "number" })
                    </div>
                    @Html.ValidationMessageFor(i => i.Product.RetailPrice, "Please enter a product Retail Price.")
                </div>
            </section>
            <section>
                <div class="form-group">
                    @Html.Label("Categories")
                    @Html.Partial("ProductCategories", new { Model.Categories, Model.SelectedCategories })
                </div>
            </section>

            <section>
                <div class="form-group">
                    @Html.Label("Images")
                    <ul id="sortable-list" class="multipleUploadContainer">
                        <li id="image1">@Html.Partial("ImageUploader")</li>
                        <li id="image2">@Html.Partial("ImageUploader")</li>
                        <li id="image3">@Html.Partial("ImageUploader")</li>
                        <li id="image4">@Html.Partial("ImageUploader")</li>
                        <li id="image5">@Html.Partial("ImageUploader")</li>
                        <li id="image6">@Html.Partial("ImageUploader")</li>
                    </ul>
                    <div class="clearfix"></div>
                    @(Html.Kendo().Sortable()
                          .For("#sortable-list")
                          .Cursor("url('" + Url.Content("~/content/kendo/images/grabbing.cur") + "'), default")
                          .Events(e => e.Change("onChange"))
                          .Filter(".sortable")
                          .Deferred()
                    )
                    <div class="help-block">
                        <ul class="fa-ul">
                            <li><i class="fa-li fa fa-asterisk"></i><strong>Size:</strong> We recommend uploading images that are at least <strong>1600px wide</strong>.</li>
                            <li><i class="fa-li fa fa-asterisk"></i><strong>Hint:</strong> You can re-order images by dragging them above.</li>
                        </ul>
                    </div>
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.Product.VideoUrl, "YouTube Embed URL") (optional)
                    @Html.TextBoxFor(m => m.Product.VideoUrl, new { @class = "form-control", @type = "url" })
                    <div class="help-block">Copy-and-paste the YouTube embed URL here, for example https://www.youtube.com/embed/cchSQ0R_Obw</div>
                </div>
            </section>

            <section class="form-buttons">
                <button type="submit" class="btn btn-default">Save</button>
            </section>
            @Html.HiddenFor(i => i.GoToAuction)

        }
    </div>
</div>

@section scripts {
    @Scripts.Render("~/js/validate")
    @Scripts.Render("~/js/image-uploader")
    <script src="//cdn.ckeditor.com/4.4.4/basic/ckeditor.js"></script>
    <script>


        (function ($) {


            $(function () {
                bindEvents();
                initCkEditor();
            });

            var bindEvents = function () {

                var multiUploaders = $(".multipleUploadContainer .image-uploader");



                @for (var i = 0; i < 6; i++)
                {
                    var productImage = Model.Product.ProductImages.ElementAtOrDefault(i);
                    var productImageId = productImage != null ? productImage.ProductImageId.ToString(CultureInfo.InvariantCulture) : "";
                    var productImageUrl = productImage != null ? productImage.ImageMdUrl : "";

                    <text>
                $(multiUploaders.get(@i)).fileUpload({
                    itemId: "@productImageId",
                    parentId: "@Model.Product.ProductId",
                    imageUrl: "@productImageUrl",
                    uploadUrl: "/admin/products/UploadImage",
                    deleteUrl: "/admin/products/DeleteImage",
                    onUploadSuccessCallback: function (file, response) {

                        $("#image@(i + 1)").removeClass("disabled");
                        $("#image@(i + 1)").addClass("sortable");
                        $("#image@(i + 1)").attr("data-imgid", response.itemId);
                        displayUploader();

                    },
                    onDeleteSuccessCallback: function () {
                        $("#image@(i + 1)").removeClass("sortable");
                        $("#image@(i + 1)").addClass("disabled");
                        $("#image@(i + 1)").removeAttr("data-imgid");
                        displayUploader();

                    }
                });
                </text>
                    if (productImage == null)
                    {
                        <text>
                $("#image@(i + 1)").addClass("disabled");
                </text>
                    }
                    else
                    {
                        <text>
                $("#image@(i + 1)").addClass("sortable");
                $("#image@(i + 1)").attr("data-imgid", "@productImageId");

                </text>
                    }
                }
                displayUploader();

                $("[name='SelectedCategories']").on("change", onCategoryChange);


            };

            var onCategoryChange = function () {
                var checkbox = $(this);
                var checked = checkbox.is(":checked");
                var categoryId = checkbox.val();
                var parentCategoryId = checkbox.attr('parentId');

                if (checked) {
                    var parentCheckbox = $("#Category" + parentCategoryId);
                    visuallyDisable(parentCheckbox);
                    parentCheckbox.prop('checked', checked).each(onCategoryChange);
                }

                if (!checked) {
                    visuallyEnable(checkbox);
                    var childCheckbox = $("input[parentId='" + categoryId + "']");
                    childCheckbox.prop('checked', checked).each(onCategoryChange);
                }
            };

            var visuallyDisable = function (checkbox) {
                if (!checkbox.is(":checked")) {
                    checkbox.addClass("disabledCheckbox");
                    checkbox.parent().addClass("disabledLabel");
                }
            };

            var visuallyEnable = function (checkbox) {
                checkbox.removeClass("disabledCheckbox");
                checkbox.parent().removeClass("disabledLabel");
            };

            var initCkEditor = function () {
                $("textarea.localized-input[data-language!='ar']").each(function () {
                    CKEDITOR.replace(this.id, { height: 300 });
                });

                $("textarea.localized-input[data-language='ar']").each(function () {
                    CKEDITOR.replace(this.id, { height: 300, contentsLangDirection: "rtl" });
                });

                // CK editor breaks localized content validation so disable with hack
                var hiddenValidator = $("input[name='Product.Description']");
                if (hiddenValidator.val().length === 0) {
                    hiddenValidator.val("...");
                    hiddenValidator.siblings(".localized-input").val("<p></p>");
                }
            };

            //event for ProductSpecification Section
            //$(".dropdown").parent().next().children().children().css({ "border": "2px solid red" });
            $(".PSDropDown").parent().parent().parent().hide();
            $(".PSDropDown").parent().next().addClass("form-group-disabled");
            $(".PSDropDown").parent().next().children().find("input").prop("disabled", true);
            var count = 0;
            $(".PSDropDown").each(function () {

                if ($(this).val() != -1) {
                    $(this).parent().parent().parent().show();
                    $(this).parent().next().removeClass("form-group-disabled");
                    $(this).parent().next().children().find("input").prop("disabled", false);
                    $(this).parent().parent().parent().next().show();
                    ++count;
                }
            });
            if (count == 0) {
                $(".PSDropDown").first().parent().parent().parent().show();

            }

            $(".PSDropDown").change(function () {

                if ($(this).val() != -1) {
                    $(this).parent().next().removeClass("form-group-disabled");
                    $(this).parent().parent().parent().next().show();
                    $(this).parent().next().children().find("input").prop("disabled", false);
                }

            });


            $.validator.addMethod("checkMultiPS", function (value, element) {

                return  CheckSelection(value);

            }, "invalid product specification. you can't select same specification more than once.");

            $.validator.classRuleSettings.checkMultiPS = { checkMultiPS: true };

            
            var CheckSelection = function (value) {
                var isOk = 0;
                $(".PSDropDown").each(function () {

                    if ($(this).val() != -1 && $(this).val() == value) {
                        ++isOk ;
                    }

                });

                return isOk<=1;
            }



        })(jQuery);

        function onChange(e) {
            var id = e.item.attr("id"),
                newIndex = e.newIndex,
                oldIndex = e.oldIndex,
                imageID = e.item.attr("data-imgid");
            $.ajax({
                url: "/admin/products/UpdateImageOrder/?imageId=" + imageID + "&newIndex=" + newIndex,
                context: document.body
            }).done(function () {

            });

        }

        var displayUploader = function () {
            $(".multipleUploadContainer .image-uploader").hide();
            var multiUploaders = $(".multipleUploadContainer .image-uploader");

            var imgCount = 0;

            for (var i = 0; i < 6; i++) {
                if ($("#image" + (i + 1)).attr("data-imgid") != undefined) {
                    $(multiUploaders.get(i)).show();
                    ++imgCount;
                }
            }

            if (imgCount < 5) {
                for (var j = 0; j < 6; j++) {
                    if ($("#image" + (j + 1)).attr("data-imgid") == undefined) {
                        $(multiUploaders.get(j)).show();
                        break;
                    }
                }
            }
        };



    </script>
}